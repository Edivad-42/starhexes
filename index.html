<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e293b">
  <title>Star Hexes</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }

    #root {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const StarHexesGame = () => {
      // ==================== STATE ====================
      const [config, setConfig] = useState(null);
      const [units, setUnits] = useState([]);
      const [capitalShips, setCapitalShips] = useState({ player1: null, player2: null });
      const [currentPlayer, setCurrentPlayer] = useState(1);
      const [selectedUnit, setSelectedUnit] = useState(null);
      const [activatedUnits, setActivatedUnits] = useState(new Set());
      const [gamePhase, setGamePhase] = useState('action'); // 'action' or 'combat'
      const [combatLog, setCombatLog] = useState([]);
      const [showCombatLog, setShowCombatLog] = useState(false);
      const [showUnitInfo, setShowUnitInfo] = useState(false);
      const [needsAIMove, setNeedsAIMove] = useState(false);

      const unitsRef = useRef(units);
      const capitalShipsRef = useRef(capitalShips);
      const activatedRef = useRef(activatedUnits);

      useEffect(() => {
        unitsRef.current = units;
        capitalShipsRef.current = capitalShips;
        activatedRef.current = activatedUnits;
      }, [units, capitalShips, activatedUnits]);

      // ==================== LOAD CONFIG ====================
      useEffect(() => {
        fetch('config.json')
          .then(res => res.json())
          .then(data => {
            setConfig(data);

            setCapitalShips({
              player1: {
                ...data.capitalShips.player1,
                currentHealth: data.capitalShips.player1.health
              },
              player2: {
                ...data.capitalShips.player2,
                currentHealth: data.capitalShips.player2.health
              }
            });

            const initialUnits = [];
            let unitId = 1;

            data.startingUnits.player1.forEach(u => {
              const unitType = data.unitTypes[u.type];
              initialUnits.push({
                id: `p1_${unitId++}`,
                player: 1,
                q: u.q,
                r: u.r,
                health: unitType.health,
                maxHealth: unitType.health,
                type: u.type,
                damage: unitType.damage,
                capitalDamage: unitType.capitalDamage
              });
            });

            unitId = 1;
            data.startingUnits.player2.forEach(u => {
              const unitType = data.unitTypes[u.type];
              initialUnits.push({
                id: `p2_${unitId++}`,
                player: 2,
                q: u.q,
                r: u.r,
                health: unitType.health,
                maxHealth: unitType.health,
                type: u.type,
                damage: unitType.damage,
                capitalDamage: unitType.capitalDamage
              });
            });

            setUnits(initialUnits);
          })
          .catch(err => console.error('Error loading config:', err));
      }, []);

      // ==================== HEX UTILITIES ====================
      // Offset coordinates: even rows shift right
      const getNeighbors = (q, r) => {
        const evenRow = r % 2 === 0;
        if (evenRow) {
          return [
            [q + 1, r], [q - 1, r],
            [q, r - 1], [q - 1, r - 1],
            [q, r + 1], [q - 1, r + 1]
          ];
        } else {
          return [
            [q + 1, r], [q - 1, r],
            [q + 1, r - 1], [q, r - 1],
            [q + 1, r + 1], [q, r + 1]
          ];
        }
      };

      const getUnitAt = (q, r) => {
        return unitsRef.current.find(u => u.q === q && u.r === r && u.health > 0);
      };

      const isOccupied = (q, r, excludeId = null) => {
        return unitsRef.current.some(u => u.q === q && u.r === r && u.id !== excludeId && u.health > 0);
      };

      const isEngaged = (unit) => {
        const neighbors = getNeighbors(unit.q, unit.r);
        return neighbors.some(([q, r]) => {
          const neighbor = getUnitAt(q, r);
          return neighbor && neighbor.player !== unit.player;
        });
      };

      const getValidMoves = (unit) => {
        if (isEngaged(unit)) return []; // Engaged units can't move

        const neighbors = getNeighbors(unit.q, unit.r);
        return neighbors.filter(([q, r]) =>
          q >= 0 && q < config.map.width &&
          r >= 0 && r < config.map.height &&
          !isOccupied(q, r, unit.id) &&
          !config.map.disabledHexes.some(hex => hex.q === q && hex.r === r)
        );
      };

      // ==================== CHECK ALL UNITS ACTIVATED ====================
      useEffect(() => {
        if (gamePhase !== 'action') return;

        const aliveUnits = units.filter(u => u.health > 0);
        if (aliveUnits.length === 0) return;

        const allActivated = aliveUnits.every(u => activatedUnits.has(u.id));

        if (allActivated) {
          console.log('All units activated - starting combat');
          resolveCombat();
        }
      }, [activatedUnits, gamePhase, units]);

      // ==================== AI TURN ====================
      useEffect(() => {
        if (!needsAIMove || gamePhase !== 'action' || currentPlayer !== 2) return;

        const timer = setTimeout(() => {
          makeAIMove();
        }, 1000);

        return () => clearTimeout(timer);
      }, [needsAIMove, gamePhase, currentPlayer]);

      const makeAIMove = () => {
        setNeedsAIMove(false);

        const aiUnits = unitsRef.current.filter(u => u.player === 2 && u.health > 0 && !activatedRef.current.has(u.id));

        if (aiUnits.length === 0) {
          setCurrentPlayer(1);
          return;
        }

        const aiUnit = aiUnits[0];
        const playerUnits = unitsRef.current.filter(u => u.player === 1 && u.health > 0);
        const validMoves = getValidMoves(aiUnit);

        // If can't move, just activate
        if (validMoves.length === 0) {
          setActivatedUnits(prev => new Set([...prev, aiUnit.id]));
          setCurrentPlayer(1);
          return;
        }

        // Simple AI: move towards nearest enemy
        let bestMove = validMoves[0];
        let minDistance = Infinity;

        validMoves.forEach(([mq, mr]) => {
          playerUnits.forEach(pUnit => {
            const dist = Math.abs(mq - pUnit.q) + Math.abs(mr - pUnit.r);
            if (dist < minDistance) {
              minDistance = dist;
              bestMove = [mq, mr];
            }
          });
        });

        setUnits(prevUnits => prevUnits.map(u =>
          u.id === aiUnit.id ? { ...u, q: bestMove[0], r: bestMove[1] } : u
        ));
        setActivatedUnits(prev => new Set([...prev, aiUnit.id]));
        setCurrentPlayer(1);
      };

      // ==================== COMBAT RESOLUTION ====================
      const resolveCombat = () => {
        console.log('=== COMBAT START ===');
        const log = [];

        // Get snapshot of alive units
        const aliveUnits = unitsRef.current.filter(u => u.health > 0);

        log.push('=== COMBAT PHASE ===');
        log.push(`Units alive: ${aliveUnits.map(u => `${u.id}(${u.health}HP)`).join(', ')}`);
        log.push('');

        // Calculate damage for each unit
        const damageQueue = {};
        aliveUnits.forEach(u => damageQueue[u.id] = 0);

        log.push('--- ATTACKS ---');
        aliveUnits.forEach(attacker => {
          const neighbors = getNeighbors(attacker.q, attacker.r);
          const enemies = aliveUnits.filter(unit => {
            return unit.player !== attacker.player &&
              neighbors.some(([nq, nr]) => unit.q === nq && unit.r === nr);
          });

          if (enemies.length === 0) {
            log.push(`${attacker.id}: No adjacent enemies`);
            return;
          }

          const damagePerEnemy = attacker.damage / enemies.length;
          log.push(`${attacker.id} (${attacker.damage} dmg) ‚Üí ${enemies.length} enemies = ${damagePerEnemy.toFixed(1)} dmg each`);

          enemies.forEach(enemy => {
            damageQueue[enemy.id] += damagePerEnemy;
            log.push(`  ‚Üí ${enemy.id} receives ${damagePerEnemy.toFixed(1)} dmg`);
          });
        });

        log.push('');
        log.push('--- DAMAGE APPLICATION ---');

        // Apply damage
        const updatedUnits = unitsRef.current.map(unit => {
          if (unit.health <= 0) return unit;

          const damage = damageQueue[unit.id] || 0;
          if (damage > 0) {
            const newHealth = Math.max(0, unit.health - damage);
            log.push(`${unit.id}: ${unit.health.toFixed(1)} - ${damage.toFixed(1)} = ${newHealth.toFixed(1)} HP ${newHealth === 0 ? 'üíÄ' : ''}`);
            return { ...unit, health: newHealth };
          }
          return unit;
        });

        log.push('');
        log.push('--- CAPITAL SHIP ATTACKS ---');

        // Capital ship damage
        let newCapitalShips = { ...capitalShipsRef.current };
        let capitalDamaged = false;

        aliveUnits.forEach(unit => {
          const isInP1Zone = config.capitalZones.player1.some(z => z.q === unit.q && z.r === unit.r);
          const isInP2Zone = config.capitalZones.player2.some(z => z.q === unit.q && z.r === unit.r);
          const isInEnemyZone = unit.player === 1 ? isInP2Zone : isInP1Zone;

          if (!isInEnemyZone) return;

          const neighbors = getNeighbors(unit.q, unit.r);
          const hasEnemies = aliveUnits.some(other => {
            return other.player !== unit.player &&
              neighbors.some(([nq, nr]) => other.q === nq && other.r === nr);
          });

          if (hasEnemies) {
            log.push(`${unit.id}: In enemy zone but ENGAGED - no capital damage`);
            return;
          }

          const targetShip = unit.player === 1 ? 'player2' : 'player1';
          const oldHealth = newCapitalShips[targetShip].currentHealth;
          newCapitalShips[targetShip] = {
            ...newCapitalShips[targetShip],
            currentHealth: Math.max(0, oldHealth - unit.capitalDamage)
          };

          capitalDamaged = true;
          log.push(`${unit.id}: Strikes ${newCapitalShips[targetShip].name} for ${unit.capitalDamage} dmg (${oldHealth} ‚Üí ${newCapitalShips[targetShip].currentHealth})`);
        });

        if (!capitalDamaged) {
          log.push('No capital ship damage');
        }

        log.push('');
        log.push('=== COMBAT END ===');

        console.log('Combat log:', log);

        setUnits(updatedUnits);
        setCapitalShips(newCapitalShips);
        setCombatLog(log);
        setShowCombatLog(true);
        setGamePhase('combat');
      };

      const handleCombatLogOk = () => {
        console.log('Combat log OK');
        setShowCombatLog(false);
        setCombatLog([]);
        setGamePhase('action');
        setActivatedUnits(new Set());
        setCurrentPlayer(1);
        setSelectedUnit(null);
      };

      // ==================== PLAYER ACTIONS ====================
      const handleUnitClick = (unit) => {
        if (gamePhase !== 'action') return;
        if (unit.player !== currentPlayer) return;
        if (currentPlayer !== 1) return; // Only player 1 is human
        if (activatedUnits.has(unit.id)) return;

        setSelectedUnit(unit);
      };

      const handleHexClick = (q, r) => {
        if (!selectedUnit || gamePhase !== 'action' || currentPlayer !== 1) return;
        if (activatedUnits.has(selectedUnit.id)) return;

        const validMoves = getValidMoves(selectedUnit);
        const isValid = validMoves.some(([mq, mr]) => mq === q && mr === r);

        if (isValid) {
          setUnits(prev => prev.map(u =>
            u.id === selectedUnit.id ? { ...u, q, r } : u
          ));
          setActivatedUnits(prev => new Set([...prev, selectedUnit.id]));
          setSelectedUnit(null);
          setCurrentPlayer(2);
          setNeedsAIMove(true);
        }
      };

      const handlePass = () => {
        if (!selectedUnit || activatedUnits.has(selectedUnit.id)) return;

        setActivatedUnits(prev => new Set([...prev, selectedUnit.id]));
        setSelectedUnit(null);
        setCurrentPlayer(2);
        setNeedsAIMove(true);
      };

      // ==================== RENDERING ====================
      if (!config) {
        return (
          <div className="w-full h-full bg-gray-800 flex items-center justify-center">
            <div className="text-white text-xl">Loading...</div>
          </div>
        );
      }

      const hexSize = config.map.hexSize;
      const hexWidth = hexSize * Math.sqrt(3);
      const hexHeight = hexSize * 2;
      const vertDist = hexHeight * 0.75;

      return (
        <div className="w-full h-full bg-gray-800 flex flex-col">
          {/* Top Bar */}
          <div className="flex justify-center items-center py-2 bg-gray-900 text-white">
            {gamePhase === 'action' ? (
              <>
                <span className={currentPlayer === 1 ? 'text-blue-400' : 'text-red-400'}>
                  P{currentPlayer}
                </span>
                {' '}- {currentPlayer === 1 ? 'Move unit' : 'AI thinking...'}
              </>
            ) : (
              <span className="text-yellow-400">COMBAT</span>
            )}
          </div>

          {/* Game Board */}
          <div className="flex-1 relative overflow-hidden">
            <svg width="100%" height="100%" className="bg-gray-900" viewBox="0 0 600 400" preserveAspectRatio="xMidYMid meet">
              {/* Capital ship labels */}
              <text x="10" y="100" fill="#3b82f6" fontSize="11" fontWeight="bold" transform="rotate(-30 10 100)">
                {config.capitalShips.player1.name}
              </text>
              <text x="585" y="300" fill="#ef4444" fontSize="11" fontWeight="bold" textAnchor="end" transform="rotate(-30 585 300)">
                {config.capitalShips.player2.name}
              </text>

              {/* Hexes */}
              {Array.from({ length: config.map.height }, (_, r) =>
                Array.from({ length: config.map.width }, (_, q) => {
                  if (config.map.disabledHexes.some(h => h.q === q && h.r === r)) return null;

                  const x = hexWidth * q + (r % 2) * (hexWidth / 2) + 40;
                  const y = vertDist * r + 35;

                  const unit = units.find(u => u.q === q && u.r === r && u.health > 0);
                  const isSelected = selectedUnit && selectedUnit.q === q && selectedUnit.r === r;

                  const validMoves = selectedUnit && !activatedUnits.has(selectedUnit.id) ? getValidMoves(selectedUnit) : [];
                  const isValidMove = validMoves.some(([mq, mr]) => mq === q && mr === r);

                  const isP1Zone = config.capitalZones.player1.some(z => z.q === q && z.r === r);
                  const isP2Zone = config.capitalZones.player2.some(z => z.q === q && z.r === r);

                  let fill = '#1e293b';
                  let stroke = '#475569';
                  let strokeWidth = 2;

                  if (isP1Zone) { fill = '#1e3a5f'; stroke = '#3b82f6'; strokeWidth = 4; }
                  if (isP2Zone) { fill = '#4a1a1a'; stroke = '#ef4444'; strokeWidth = 4; }
                  if (isValidMove) fill = '#064e3b';
                  if (isSelected) fill = '#fbbf24';

                  return (
                    <g key={`${q}-${r}`}>
                      <polygon
                        points={`${x},${y - hexSize} ${x + hexSize * 0.866},${y - hexSize / 2} ${x + hexSize * 0.866},${y + hexSize / 2} ${x},${y + hexSize} ${x - hexSize * 0.866},${y + hexSize / 2} ${x - hexSize * 0.866},${y - hexSize / 2}`}
                        fill={fill}
                        stroke={stroke}
                        strokeWidth={strokeWidth}
                        onClick={() => unit ? handleUnitClick(unit) : handleHexClick(q, r)}
                        className="cursor-pointer hover:opacity-80"
                      />

                      {unit && (
                        <>
                          <circle
                            cx={x}
                            cy={y}
                            r={20}
                            fill={config.players[`player${unit.player}`].color}
                            stroke={activatedUnits.has(unit.id) ? '#22c55e' : '#ffffff'}
                            strokeWidth="3"
                            onClick={() => handleUnitClick(unit)}
                            className="cursor-pointer"
                          />
                          <image
                            href={config.unitTypes[unit.type].icon}
                            x={x - 12}
                            y={y - 12}
                            width={24}
                            height={24}
                            style={{ pointerEvents: 'none' }}
                          />
                          <text
                            x={x}
                            y={y + 12}
                            textAnchor="middle"
                            fill="white"
                            fontSize="9"
                            fontWeight="bold"
                            style={{ pointerEvents: 'none' }}
                          >
                            {Math.round(unit.health)}
                          </text>
                        </>
                      )}
                    </g>
                  );
                })
              )}
            </svg>

            {/* Action Buttons */}
            {selectedUnit && !activatedUnits.has(selectedUnit.id) && gamePhase === 'action' && (
              <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2">
                <button onClick={handlePass} className="px-4 py-2 bg-gray-700 text-white rounded-lg">
                  Pass
                </button>
                <button onClick={() => setShowUnitInfo(true)} className="px-4 py-2 bg-blue-600 text-white rounded-lg">
                  ‚ÑπÔ∏è Info
                </button>
              </div>
            )}
          </div>

          {/* Bottom Status */}
          <div className="grid grid-cols-2 gap-1 p-1 bg-gray-900 text-xs">
            <div className="bg-blue-900 p-1 rounded">
              <div className="flex justify-between text-white mb-1">
                <span className="font-bold">P1</span>
                <span>{units.filter(u => u.player === 1 && u.health > 0).length} units</span>
              </div>
              <div className="flex items-center gap-1">
                <div className="flex-1 bg-gray-700 rounded h-2">
                  <div
                    className="bg-blue-400 h-full"
                    style={{ width: `${(capitalShips.player1?.currentHealth / capitalShips.player1?.health * 100) || 0}%` }}
                  ></div>
                </div>
                <span className="text-white text-[10px]">{capitalShips.player1?.currentHealth || 0}</span>
              </div>
            </div>
            <div className="bg-red-900 p-1 rounded">
              <div className="flex justify-between text-white mb-1">
                <span className="font-bold">P2</span>
                <span>{units.filter(u => u.player === 2 && u.health > 0).length} units</span>
              </div>
              <div className="flex items-center gap-1">
                <div className="flex-1 bg-gray-700 rounded h-2">
                  <div
                    className="bg-red-400 h-full"
                    style={{ width: `${(capitalShips.player2?.currentHealth / capitalShips.player2?.health * 100) || 0}%` }}
                  ></div>
                </div>
                <span className="text-white text-[10px]">{capitalShips.player2?.currentHealth || 0}</span>
              </div>
            </div>
          </div>

          {/* Combat Log Modal */}
          {showCombatLog && (
            <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
              <div className="bg-gray-900 rounded-lg p-6 max-w-2xl w-full mx-4 border-4 border-yellow-500 max-h-[80vh] flex flex-col">
                <h2 className="text-3xl font-bold text-yellow-400 text-center mb-4">‚öîÔ∏è COMBAT LOG ‚öîÔ∏è</h2>

                <div className="flex-1 overflow-y-auto bg-gray-800 rounded p-4 mb-4 font-mono text-sm text-white">
                  {combatLog.map((line, i) => (
                    <div key={i} className="mb-1">{line}</div>
                  ))}
                </div>

                <button
                  onClick={handleCombatLogOk}
                  className="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white text-xl font-bold rounded-lg"
                >
                  OK
                </button>
              </div>
            </div>
          )}

          {/* Unit Info Modal */}
          {showUnitInfo && selectedUnit && (
            <div
              className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50"
              onClick={() => setShowUnitInfo(false)}
            >
              <div
                className="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 border-4"
                style={{ borderColor: config.players[`player${selectedUnit.player}`].color }}
                onClick={(e) => e.stopPropagation()}
              >
                <div className="flex items-center gap-4 mb-4">
                  <img src={config.unitTypes[selectedUnit.type].icon} alt="" className="w-16 h-16" />
                  <div>
                    <h2 className="text-2xl font-bold text-white">{config.unitTypes[selectedUnit.type].name}</h2>
                    <p className="text-gray-400 text-sm">{selectedUnit.id}</p>
                  </div>
                </div>

                <p className="text-gray-300 mb-4 italic">{config.unitTypes[selectedUnit.type].description}</p>

                <div className="grid grid-cols-2 gap-3 mb-4">
                  <div className="bg-gray-700 rounded p-2">
                    <div className="text-gray-400 text-xs mb-1">Health</div>
                    <div className="flex items-center gap-2">
                      <div className="flex-1 bg-gray-600 rounded h-3">
                        <div
                          className="bg-green-500 h-full"
                          style={{ width: `${(selectedUnit.health / selectedUnit.maxHealth * 100)}%` }}
                        ></div>
                      </div>
                      <span className="text-white text-sm font-bold">{Math.round(selectedUnit.health)}/{selectedUnit.maxHealth}</span>
                    </div>
                  </div>

                  <div className="bg-gray-700 rounded p-2">
                    <div className="text-gray-400 text-xs">Damage</div>
                    <div className="text-white font-bold text-lg">{selectedUnit.damage}</div>
                  </div>

                  <div className="bg-gray-700 rounded p-2">
                    <div className="text-gray-400 text-xs">Capital Damage</div>
                    <div className="text-white font-bold text-lg">{selectedUnit.capitalDamage}</div>
                  </div>
                </div>

                <button
                  onClick={() => setShowUnitInfo(false)}
                  className="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg"
                >
                  Close
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<StarHexesGame />, document.getElementById('root'));
  </script>
</body>

</html>