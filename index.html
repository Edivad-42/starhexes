<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e293b">
  <title>Star Hexes</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="abilities.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }

    #root {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <!-- Menu and How To Play components -->
  <script type="text/babel">
    // Main Menu Component for Star Hexes
    const MainMenu = ({ onStartGame, onShowHowToPlay, onCustomMatch }) => {
      return (
        <div className="w-full h-full bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 flex items-center justify-center">
          <div className="text-center space-y-8 px-4">
            {/* Title */}
            <div>
              <h1 className="text-6xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-2">
                STAR HEXES
              </h1>
              <p className="text-gray-400 text-lg tracking-widest">TACTICAL SPACE COMBAT</p>
            </div>

            {/* Main Buttons */}
            <div className="space-y-4">
              <button
                onClick={onStartGame}
                className="w-64 px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold rounded-lg shadow-lg hover:shadow-blue-500/50 transition-all transform hover:scale-105 active:scale-95"
              >
                üéØ Quick Match
              </button>

              <button
                onClick={onShowHowToPlay}
                className="w-64 px-8 py-4 bg-purple-600 hover:bg-purple-700 text-white text-xl font-bold rounded-lg shadow-lg hover:shadow-purple-500/50 transition-all transform hover:scale-105 active:scale-95"
              >
                üìñ How to Play
              </button>

              {/* Coming Soon Buttons */}
              <button
                onClick={onCustomMatch}
                className="w-64 px-8 py-4 bg-green-600 hover:bg-green-700 text-white text-xl font-bold rounded-lg shadow-lg hover:shadow-purple-500/50 transition-all transform hover:scale-105 active:scale-95"
              >
                Custom Match
              </button>


              <button
                disabled
                className="w-64 px-8 py-4 bg-gray-700 text-gray-500 text-xl font-bold rounded-lg cursor-not-allowed opacity-50"
              >
                ‚öôÔ∏è Settings <span className="text-sm">(Coming Soon)</span>
              </button>
            </div>

            {/* Version Info */}
            <div className="text-gray-500 text-sm mt-8">
              v0.1.0 Alpha
            </div>
          </div>
        </div>
      );
    };

    // How to Play Component for Star Hexes
    const HowToPlay = ({ onBack }) => {
      return (
        <div className="w-full h-full bg-gray-900 overflow-auto">
          <div className="max-w-3xl mx-auto p-6 text-white">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                How to Play
              </h1>
              <button
                onClick={onBack}
                className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
              >
                ‚Üê Back to Menu
              </button>
            </div>

            {/* Content */}
            <div className="space-y-6 text-gray-300">

              {/* Goal */}
              <section className="bg-gray-800 rounded-lg p-4">
                <h2 className="text-xl font-bold text-blue-400 mb-2">üéØ Goal</h2>
                <p>
                  Win by destroying the enemy Capital Ship (reduce it to 0 HP) OR by eliminating all enemy units.
                </p>
              </section>

              {/* Turn Structure */}
              <section className="bg-gray-800 rounded-lg p-4">
                <h2 className="text-xl font-bold text-blue-400 mb-2">üîÑ Turn Structure</h2>
                <p className="mb-2">The game alternates between <strong>Action Phase</strong> and <strong>Combat Phase</strong>:</p>
                <ul className="list-disc list-inside space-y-1 ml-2">
                  <li><strong>Action Phase:</strong> Players take turns activating their units. Each unit can move once per round.</li>
                  <li><strong>Combat Phase:</strong> After all units are activated, simultaneous combat occurs between adjacent enemy units.</li>
                </ul>
              </section>

              {/* Movement & Engagement */}
              <section className="bg-gray-800 rounded-lg p-4">
                <h2 className="text-xl font-bold text-blue-400 mb-2">üöÄ Movement & Engagement</h2>
                <ul className="list-disc list-inside space-y-1 ml-2">
                  <li>Units can move to any adjacent hex (1 hex per turn by default).</li>
                  <li><strong>Engaged Units:</strong> If a unit is adjacent to an enemy, it is <strong>engaged</strong> and <strong>cannot move</strong>.</li>
                  <li>You can choose to <strong>Pass</strong> without moving if needed.</li>
                </ul>
              </section>

              {/* Combat */}
              <section className="bg-gray-800 rounded-lg p-4">
                <h2 className="text-xl font-bold text-blue-400 mb-2">‚öîÔ∏è Combat</h2>
                <ul className="list-disc list-inside space-y-1 ml-2">
                  <li>Combat happens automatically during the Combat Phase.</li>
                  <li>Units deal damage to all adjacent enemies simultaneously.</li>
                  <li>If a unit has multiple adjacent enemies, its damage is split evenly among them.</li>
                  <li>Combat events appear in the feed at the top of the screen.</li>
                </ul>
              </section>

              {/* Abilities */}
              <section className="bg-gray-800 rounded-lg p-4">
                <h2 className="text-xl font-bold text-blue-400 mb-2">‚ö° Abilities</h2>
                <ul className="list-disc list-inside space-y-1 ml-2">
                  <li><strong>Active Abilities:</strong> Can be triggered by clicking the ability button when a unit is selected. Some abilities have limited charges or cooldowns.</li>
                  <li><strong>Movement Abilities:</strong> Replace your normal movement (e.g., Boost lets you move 2 hexes instead of 1).</li>
                  <li><strong>Attack Abilities:</strong> Allow ranged attacks or special effects. You can still move after using these.</li>
                  <li><strong>Passive Abilities:</strong> Always active and provide constant bonuses (shown as disabled buttons for reference).</li>
                  <li>Click the <strong>‚ÑπÔ∏è Info</strong> button to see details about any unit's abilities.</li>
                </ul>
              </section>

              {/* Capital Ships */}
              <section className="bg-gray-800 rounded-lg p-4">
                <h2 className="text-xl font-bold text-blue-400 mb-2">üõ°Ô∏è Capital Ships</h2>
                <ul className="list-disc list-inside space-y-1 ml-2">
                  <li>Each player has a Capital Ship in their home zone (3 hexes highlighted in blue or red).</li>
                  <li>Capital Ships don't move but have high HP.</li>
                  <li>Units in the enemy's capital zone can damage the Capital Ship if they're not engaged with enemy units.</li>
                  <li>The amount of damage depends on the unit's <strong>Capital Damage</strong> stat.</li>
                </ul>
              </section>

              {/* Tips */}
              <section className="bg-gray-800 rounded-lg p-4">
                <h2 className="text-xl font-bold text-blue-400 mb-2">üí° Tips</h2>
                <ul className="list-disc list-inside space-y-1 ml-2">
                  <li>Use the Info button to inspect any unit (yours or enemy) to see their stats and abilities.</li>
                  <li>Plan your moves carefully - engaged units can't retreat!</li>
                  <li>Different unit types excel at different roles: fighters for combat, bombers for capital ships.</li>
                  <li>Watch your ability cooldowns and charges to maximize their impact.</li>
                </ul>
              </section>

            </div>

            {/* Bottom spacing */}
            <div className="h-8"></div>
          </div>
        </div>
      );
    };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const StarHexesGame = () => {
      // ==================== STATE ====================
      const [gameState, setGameState] = useState('menu');
      const [customSetup, setCustomSetup] = useState({
        player1: [],
        player2: []
      });
      const [config, setConfig] = useState(null);
      const [units, setUnits] = useState([]);
      const [capitalShips, setCapitalShips] = useState({ player1: null, player2: null });
      const [currentPlayer, setCurrentPlayer] = useState(1);
      const [selectedUnit, setSelectedUnit] = useState(null);
      const [activatedUnits, setActivatedUnits] = useState(new Set());
      const [gamePhase, setGamePhase] = useState('action'); // 'action' or 'combat'
      const [combatLog, setCombatLog] = useState([]);
      const [showCombatLog, setShowCombatLog] = useState(false);
      const [showUnitInfo, setShowUnitInfo] = useState(false);
      const [needsAIMove, setNeedsAIMove] = useState(false);
      const [activeAbility, setActiveAbility] = useState(null);
      const [winner, setWinner] = useState(null);

      const unitsRef = useRef(units);
      const capitalShipsRef = useRef(capitalShips);
      const activatedRef = useRef(activatedUnits);

      const DEFAULT_SPAWNS = {
        player1: [
          { q: 2, r: 1 },
          { q: 2, r: 2 },
          { q: 1, r: 3 }
        ],
        player2: [
          { q: 7, r: 4 },
          { q: 6, r: 5 },
          { q: 6, r: 6 }
        ]
      };

      useEffect(() => {
        unitsRef.current = units;
        capitalShipsRef.current = capitalShips;
        activatedRef.current = activatedUnits;
      }, [units, capitalShips, activatedUnits]);

      // ==================== LOAD CONFIG ====================
      useEffect(() => {
        fetch('config.json')
          .then(res => res.json())
          .then(data => {
            setConfig(data);

            setCapitalShips({
              player1: {
                ...data.capitalShips.player1,
                currentHealth: data.capitalShips.player1.health
              },
              player2: {
                ...data.capitalShips.player2,
                currentHealth: data.capitalShips.player2.health
              }
            });

            const initialUnits = [];
            let unitId = 1;

            data.startingUnits.player1.forEach(u => {
              const unitType = data.unitTypes[u.type];
              const unit = {
                id: `p1_${unitId++}`,
                player: 1,
                q: u.q,
                r: u.r,
                health: unitType.health,
                maxHealth: unitType.health,
                type: u.type,
                damage: unitType.damage,
                capitalDamage: unitType.capitalDamage
              };

              AbilitySystem.initAbilities(unit, unitType.abilities || []);
              initialUnits.push(unit);
            });

            unitId = 1;
            data.startingUnits.player2.forEach(u => {
              const unitType = data.unitTypes[u.type];
              const unit = {
                id: `p2_${unitId++}`,
                player: 2,
                q: u.q,
                r: u.r,
                health: unitType.health,
                maxHealth: unitType.health,
                type: u.type,
                damage: unitType.damage,
                capitalDamage: unitType.capitalDamage
              };

              AbilitySystem.initAbilities(unit, unitType.abilities || []);
              initialUnits.push(unit);
            });

            setUnits(initialUnits);
          })
          .catch(err => console.error('Error loading config:', err));
      }, []);

      // ==================== MENU HANDLERS ====================
      const handleStartGame = () => {
        setGameState('game');
      };

      const handleShowHowToPlay = () => {
        setGameState('howtoplay');
      };

      const handleBackToMenu = () => {
        setGameState('menu');
      };

      // ==================== CUSTOM GAME ====================
      const startCustomGame = () => {
        const units = [];
        let id = 1;

        customSetup.player1.forEach((type, i) => {
          const def = config.unitTypes[type];
          const spawn = DEFAULT_SPAWNS.player1[i];

          const unit = {
            id: `p1_${id++}`,
            player: 1,
            type,
            q: spawn.q,
            r: spawn.r,
            health: def.health,
            maxHealth: def.health,
            damage: def.damage,
            capitalDamage: def.capitalDamage
          };

          AbilitySystem.initAbilities(unit, def.abilities || []);
          units.push(unit);
        });

        id = 1;
        customSetup.player2.forEach((type, i) => {
          const def = config.unitTypes[type];
          const spawn = DEFAULT_SPAWNS.player2[i];

          const unit = {
            id: `p2_${id++}`,
            player: 2,
            type,
            q: spawn.q,
            r: spawn.r,
            health: def.health,
            maxHealth: def.health,
            damage: def.damage,
            capitalDamage: def.capitalDamage
          };

          AbilitySystem.initAbilities(unit, def.abilities || []);
          units.push(unit);
        });

        setUnits(units);
        setGameState('game');
      };

      // ==================== HEX UTILITIES ====================
      // Offset coordinates: even rows shift right
      const getNeighbors = (q, r) => {
        const evenRow = r % 2 === 0;
        if (evenRow) {
          return [
            [q + 1, r], [q - 1, r],
            [q, r - 1], [q - 1, r - 1],
            [q, r + 1], [q - 1, r + 1]
          ];
        } else {
          return [
            [q + 1, r], [q - 1, r],
            [q + 1, r - 1], [q, r - 1],
            [q + 1, r + 1], [q, r + 1]
          ];
        }
      };

      const getUnitAt = (q, r) => {
        return unitsRef.current.find(u => u.q === q && u.r === r && u.health > 0);
      };

      const isOccupied = (q, r, excludeId = null) => {
        return unitsRef.current.some(u => u.q === q && u.r === r && u.id !== excludeId && u.health > 0);
      };

      const isEngaged = (unit) => {
        const neighbors = getNeighbors(unit.q, unit.r);
        return neighbors.some(([q, r]) => {
          const neighbor = getUnitAt(q, r);
          return neighbor && neighbor.player !== unit.player;
        });
      };

      const getValidMoves = (unit) => {
        if (isEngaged(unit)) return []; // Engaged units can't move

        const neighbors = getNeighbors(unit.q, unit.r);
        return neighbors.filter(([q, r]) =>
          q >= 0 && q < config.map.width &&
          r >= 0 && r < config.map.height &&
          !isOccupied(q, r, unit.id) &&
          !config.map.disabledHexes.some(hex => hex.q === q && hex.r === r)
        );
      };

      // ==================== CHECK ALL UNITS ACTIVATED ====================
      useEffect(() => {
        if (gamePhase !== 'action') return;

        const aliveUnits = units.filter(u => u.health > 0);
        if (aliveUnits.length === 0) return;

        const allActivated = aliveUnits.every(u => activatedUnits.has(u.id));

        if (allActivated) {
          console.log('All units activated - starting combat');
          resolveCombat();
        }
      }, [activatedUnits, gamePhase, units]);

      // ==================== AI TURN ====================
      useEffect(() => {
        if (!needsAIMove || gamePhase !== 'action' || currentPlayer !== 2) return;

        const timer = setTimeout(() => {
          makeAIMove();
        }, 1000);

        return () => clearTimeout(timer);
      }, [needsAIMove, gamePhase, currentPlayer]);

      const makeAIMove = () => {
        setNeedsAIMove(false);

        const aiUnits = unitsRef.current.filter(u => u.player === 2 && u.health > 0 && !activatedRef.current.has(u.id));

        if (aiUnits.length === 0) {
          setCurrentPlayer(1);
          return;
        }

        const aiUnit = aiUnits[0];
        const playerUnits = unitsRef.current.filter(u => u.player === 1 && u.health > 0);
        const validMoves = getValidMoves(aiUnit);

        // If can't move, just activate
        if (validMoves.length === 0) {
          setActivatedUnits(prev => new Set([...prev, aiUnit.id]));
          setCurrentPlayer(1);
          return;
        }

        // Simple AI: move towards nearest enemy
        let bestMove = validMoves[0];
        let minDistance = Infinity;

        validMoves.forEach(([mq, mr]) => {
          playerUnits.forEach(pUnit => {
            const dist = Math.abs(mq - pUnit.q) + Math.abs(mr - pUnit.r);
            if (dist < minDistance) {
              minDistance = dist;
              bestMove = [mq, mr];
            }
          });
        });

        setUnits(prevUnits => prevUnits.map(u =>
          u.id === aiUnit.id ? { ...u, q: bestMove[0], r: bestMove[1] } : u
        ));
        setActivatedUnits(prev => new Set([...prev, aiUnit.id]));
        setCurrentPlayer(1);
      };

      // ==================== VICTORY CONDITIONS ====================
      const checkVictory = (units, capitalShips) => {
        const p1UnitsAlive = units.some(u => u.player === 1 && u.health > 0);
        const p2UnitsAlive = units.some(u => u.player === 2 && u.health > 0);

        if (!p1UnitsAlive || capitalShips.player1.currentHealth <= 0) {
          return 2;
        }

        if (!p2UnitsAlive || capitalShips.player2.currentHealth <= 0) {
          return 1;
        }

        return null;
      };

      // ==================== COMBAT RESOLUTION ====================
      const resolveCombat = () => {
        console.log('=== COMBAT START ===');
        const log = [];

        // Get snapshot of alive units
        const aliveUnits = unitsRef.current.filter(u => u.health > 0);

        log.push('=== COMBAT PHASE ===');
        log.push(`Units alive: ${aliveUnits.map(u => `${u.id}(${u.health}HP)`).join(', ')}`);
        log.push('');

        // Calculate damage for each unit
        const damageQueue = {};
        aliveUnits.forEach(u => damageQueue[u.id] = 0);

        log.push('--- ATTACKS ---');
        aliveUnits.forEach(attacker => {
          const neighbors = getNeighbors(attacker.q, attacker.r);
          const enemies = aliveUnits.filter(unit => {
            return unit.player !== attacker.player &&
              neighbors.some(([nq, nr]) => unit.q === nq && unit.r === nr);
          });

          if (enemies.length === 0) {
            log.push(`${attacker.id}: No adjacent enemies`);
            return;
          }

          const damagePerEnemy = attacker.damage / enemies.length;
          log.push(`${attacker.id} (${attacker.damage} dmg) ‚Üí ${enemies.length} enemies = ${damagePerEnemy.toFixed(1)} dmg each`);

          enemies.forEach(enemy => {
            damageQueue[enemy.id] += damagePerEnemy;
            log.push(`  ‚Üí ${enemy.id} receives ${damagePerEnemy.toFixed(1)} dmg`);
          });
        });

        log.push('');
        log.push('--- DAMAGE APPLICATION ---');

        // Apply damage
        const updatedUnits = unitsRef.current.map(unit => {
          if (unit.health <= 0) return unit;

          const damage = damageQueue[unit.id] || 0;
          if (damage > 0) {
            const newHealth = Math.max(0, unit.health - damage);
            log.push(`${unit.id}: ${unit.health.toFixed(1)} - ${damage.toFixed(1)} = ${newHealth.toFixed(1)} HP ${newHealth === 0 ? 'üíÄ' : ''}`);
            return { ...unit, health: newHealth };
          }
          return unit;
        });

        log.push('');
        log.push('--- CAPITAL SHIP ATTACKS ---');

        // Capital ship damage
        let newCapitalShips = { ...capitalShipsRef.current };
        let capitalDamaged = false;

        aliveUnits.forEach(unit => {
          const isInP1Zone = config.capitalZones.player1.some(z => z.q === unit.q && z.r === unit.r);
          const isInP2Zone = config.capitalZones.player2.some(z => z.q === unit.q && z.r === unit.r);
          const isInEnemyZone = unit.player === 1 ? isInP2Zone : isInP1Zone;

          if (!isInEnemyZone) return;

          const neighbors = getNeighbors(unit.q, unit.r);
          const hasEnemies = aliveUnits.some(other => {
            return other.player !== unit.player &&
              neighbors.some(([nq, nr]) => other.q === nq && other.r === nr);
          });

          if (hasEnemies) {
            log.push(`${unit.id}: In enemy zone but ENGAGED - no capital damage`);
            return;
          }

          const targetShip = unit.player === 1 ? 'player2' : 'player1';
          const oldHealth = newCapitalShips[targetShip].currentHealth;
          newCapitalShips[targetShip] = {
            ...newCapitalShips[targetShip],
            currentHealth: Math.max(0, oldHealth - unit.capitalDamage)
          };

          capitalDamaged = true;
          log.push(`${unit.id}: Strikes ${newCapitalShips[targetShip].name} for ${unit.capitalDamage} dmg (${oldHealth} ‚Üí ${newCapitalShips[targetShip].currentHealth})`);
        });

        if (!capitalDamaged) {
          log.push('No capital ship damage');
        }

        log.push('');
        log.push('=== COMBAT END ===');

        console.log('Combat log:', log);

        setUnits(updatedUnits);
        setCapitalShips(newCapitalShips);
        setCombatLog(log);
        setShowCombatLog(true);
        setGamePhase('combat');
        const victory = checkVictory(updatedUnits, newCapitalShips);
        if (victory) {
          setWinner(victory);
        }
      };

      const handleCombatLogOk = () => {
        console.log('Combat log OK');
        setShowCombatLog(false);
        setCombatLog([]);
        setGamePhase('action');
        setActivatedUnits(new Set());
        setCurrentPlayer(1);
        setSelectedUnit(null);
      };

      // ==================== PLAYER ACTIONS ====================
      const handleUnitClick = (unit) => {
        // Se abilit√† attiva e target valido ‚Üí usa abilit√†
        if (
          activeAbility &&
          activeAbility.validTargets.some(
            ([q, r]) => q === unit.q && r === unit.r
          )
        ) {
          handleAbilityTarget(unit.q, unit.r);
          return;
        }

        // Seleziona SEMPRE (amici o nemici)
        setSelectedUnit(unit);
      };

      const handleHexClick = (q, r) => {
        if (activeAbility) {
          handleAbilityTarget(q, r);
          return;
        }

        if (activatedUnits.has(selectedUnit.id)) return;

        const validMoves = getValidMoves(selectedUnit);
        const isValid = validMoves.some(([mq, mr]) => mq === q && mr === r);

        if (isValid) {
          setUnits(prev => prev.map(u =>
            u.id === selectedUnit.id ? { ...u, q, r } : u
          ));
          setActivatedUnits(prev => new Set([...prev, selectedUnit.id]));
          setSelectedUnit(null);
          setCurrentPlayer(2);
          setNeedsAIMove(true);
        }
      };

      const handlePass = () => {
        if (!selectedUnit || activatedUnits.has(selectedUnit.id)) return;

        setActivatedUnits(prev => new Set([...prev, selectedUnit.id]));
        setSelectedUnit(null);
        setCurrentPlayer(2);
        setNeedsAIMove(true);
      };

      const activateAbility = (unit, abilityId) => {
        // toggle off
        if (
          activeAbility &&
          activeAbility.unitId === unit.id &&
          activeAbility.abilityId === abilityId
        ) {
          setActiveAbility(null);
          return;
        }

        const ability = ABILITIES[abilityId];
        if (!ability) return;

        const result = ability.getTargets(unit, {
          getUnitAt,
          isOccupied,
          config
        });

        setActiveAbility({
          unitId: unit.id,
          abilityId,
          validTargets: result || []
        });
      };

      const handleAbilityTarget = (q, r) => {
        if (!activeAbility) return;

        const { unitId, abilityId } = activeAbility;
        const unit = unitsRef.current.find(u => u.id === unitId);
        if (!unit) return;

        const ability = ABILITIES[abilityId];
        const result = ability.onUse(unit, { q, r });

        if (result?.damage) {
          setUnits(prev =>
            prev.map(u =>
              u.q === q && u.r === r
                ? { ...u, health: Math.max(0, u.health - result.damage) }
                : u
            )
          );
        }

        setActiveAbility(null);
      };

      // ==================== RENDERING ====================
      const hexSize = config?.map.hexSize;
      const hexWidth = hexSize * Math.sqrt(3);
      const hexHeight = hexSize * 2;
      const vertDist = hexHeight * 0.75;
      const liveSelectedUnit = selectedUnit
        ? units.find(u => u.id === selectedUnit.id)
        : null;
      const gameStateForAbilities = {
        config,
        getUnitAt,
        isOccupied,
      };

      return (
        <>
          {!config && (
            <div className="w-full h-full bg-gray-800 flex items-center justify-center">
              <div className="text-white text-xl">Loading...</div>
            </div>
          )}

          {config && gameState === 'menu' && (
            <MainMenu
              onStartGame={handleStartGame}
              onShowHowToPlay={handleShowHowToPlay}
              onCustomMatch={() => setGameState('custom')}
            />
          )}

          {config && gameState === 'howtoplay' && (
            <HowToPlay onBack={handleBackToMenu} />
          )}

          {config && gameState === 'game' && (
            <div className="w-full h-full bg-gray-800 flex flex-col">
              <div className="w-full h-full bg-gray-800 flex flex-col">
                {/* Top Bar */}
                <div className="flex justify-center items-center py-2 bg-gray-900 text-white">
                  {gamePhase === 'action' ? (
                    <>
                      <span className={currentPlayer === 1 ? 'text-blue-400' : 'text-red-400'}>
                        P{currentPlayer}
                      </span>
                      {' '}- {currentPlayer === 1 ? 'Move unit' : 'AI thinking...'}
                    </>
                  ) : (
                    <span className="text-yellow-400">COMBAT</span>
                  )}
                </div>

                {/* Game Board */}
                <div className="flex-1 relative overflow-hidden">
                  <svg width="100%" height="100%" className="bg-gray-900" viewBox="0 0 600 400" preserveAspectRatio="xMidYMid meet">
                    {/* Hexes */}
                    {Array.from({ length: config.map.height }, (_, r) =>
                      Array.from({ length: config.map.width }, (_, q) => {
                        if (config.map.disabledHexes.some(h => h.q === q && h.r === r)) return null;

                        const x = hexWidth * q + (r % 2) * (hexWidth / 2) + 40;
                        const y = vertDist * r + 35;

                        const unit = units.find(u => u.q === q && u.r === r && u.health > 0);
                        const isSelected = selectedUnit && selectedUnit.q === q && selectedUnit.r === r;

                        const validMoves =
                          selectedUnit &&
                            !activatedUnits.has(selectedUnit.id) &&
                            !activeAbility
                            ? getValidMoves(selectedUnit)
                            : [];

                        const isValidMove = validMoves.some(([mq, mr]) => mq === q && mr === r);

                        const isAbilityTarget = activeAbility && activeAbility.validTargets.some(([aq, ar]) => aq === q && ar === r);

                        const isP1Zone = config.capitalZones.player1.some(z => z.q === q && z.r === r);
                        const isP2Zone = config.capitalZones.player2.some(z => z.q === q && z.r === r);

                        let fill = '#1e293b';
                        let stroke = '#475569';
                        let strokeWidth = 2;

                        if (isP1Zone) { fill = '#1e3a5f'; stroke = '#3b82f6'; strokeWidth = 2; }
                        if (isP2Zone) { fill = '#4a1a1a'; stroke = '#ef4444'; strokeWidth = 2; }
                        if (isValidMove) fill = '#064e3b';
                        if (isSelected) fill = '#fbbf24';
                        if (isAbilityTarget) fill = '#7f1d1d';

                        return (
                          <g key={`${q}-${r}`}>
                            <polygon
                              points={`${x},${y - hexSize} ${x + hexSize * 0.866},${y - hexSize / 2} ${x + hexSize * 0.866},${y + hexSize / 2} ${x},${y + hexSize} ${x - hexSize * 0.866},${y + hexSize / 2} ${x - hexSize * 0.866},${y - hexSize / 2}`}
                              fill={fill}
                              stroke={stroke}
                              strokeWidth={strokeWidth}
                              strokeLinejoin="round"
                              onClick={() => {
                                if (unit) {
                                  handleUnitClick(unit);
                                } else if (activeAbility) {
                                  // click su hex vuoto mentre abilit√† attiva ‚Üí niente
                                  return;
                                } else {
                                  handleHexClick(q, r);
                                }
                              }}
                              className="cursor-pointer hover:opacity-80"
                            />

                            {unit && (
                              <>
                                <circle
                                  cx={x}
                                  cy={y}
                                  r={20}
                                  fill={config.players[`player${unit.player}`].color}
                                  stroke={activatedUnits.has(unit.id) ? '#22c55e' : '#ffffff'}
                                  strokeWidth="3"
                                  onClick={() => handleUnitClick(unit)}
                                  className="cursor-pointer"
                                />
                                <image
                                  href={config.unitTypes[unit.type].icon}
                                  x={x - 12}
                                  y={y - 12}
                                  width={24}
                                  height={24}
                                  style={{ pointerEvents: 'none' }}
                                />
                                <text
                                  x={x}
                                  y={y + 12}
                                  textAnchor="middle"
                                  fill="white"
                                  fontSize="9"
                                  fontWeight="bold"
                                  style={{ pointerEvents: 'none' }}
                                >
                                  {Math.round(unit.health)}
                                </text>
                              </>
                            )}
                          </g>
                        );
                      })
                    )}

                    {/* Action Buttons */}
                    {liveSelectedUnit && liveSelectedUnit.player === currentPlayer && gamePhase === 'action' && (
                      <div className="flex gap-2 mt-2">
                        {AbilitySystem.getAvailableAbilities(liveSelectedUnit, gameStateForAbilities)
                          .filter(a => a.type === 'active' && a.trigger === 'attack')
                          .map(ability => {
                            const isDisabled = activatedUnits.has(liveSelectedUnit.id);

                            return (
                              <button
                                key={ability.id}
                                disabled={isDisabled}
                                onClick={() => activateAbility(liveSelectedUnit, ability.id)}
                                className={`px-3 py-2 rounded text-white ${isDisabled
                                  ? 'bg-gray-600 opacity-40'
                                  : activeAbility?.abilityId === ability.id
                                    ? 'bg-yellow-600'
                                    : 'bg-purple-700 hover:bg-purple-800'}`}
                              >
                                {ability.icon} {ability.name}
                              </button>
                            );
                          })}
                      </div>
                    )}
                    {liveSelectedUnit && (
                      <button
                        onClick={() => setShowUnitInfo(true)}
                        className="px-3 py-2 rounded bg-gray-700 hover:bg-gray-600 text-white"
                      >
                        ‚ÑπÔ∏è Info
                      </button>
                    )}
                  </svg>
                </div>

                {/* Bottom Status */}
                <div className="grid grid-cols-2 gap-1 p-1 bg-gray-900 text-xs">
                  {/* Player 1 */}
                  <div className="bg-blue-900 p-1 rounded">
                    <div className="flex justify-between text-white mb-1">
                      <span className="font-bold text-blue-300">{config.capitalShips.player1.name}</span>
                      <span>{units.filter(u => u.player === 1 && u.health > 0).length} units</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="flex-1 bg-gray-700 rounded h-2">
                        <div
                          className="bg-blue-400 h-full"
                          style={{ width: `${(capitalShips.player1?.currentHealth / capitalShips.player1?.health * 100) || 0}%` }}
                        ></div>
                      </div>
                      <span className="text-white text-[10px]">{capitalShips.player1?.currentHealth || 0}</span>
                    </div>
                  </div>

                  {/* Player 2 */}
                  <div className="bg-red-900 p-1 rounded">
                    <div className="flex justify-between text-white mb-1">
                      <span>{units.filter(u => u.player === 2 && u.health > 0).length} units</span>
                      <span className="font-bold text-red-300">{config.capitalShips.player2.name}</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="flex-1 bg-gray-700 rounded h-2">
                        <div
                          className="bg-red-400 h-full"
                          style={{ width: `${(capitalShips.player2?.currentHealth / capitalShips.player2?.health * 100) || 0}%` }}
                        ></div>
                      </div>
                      <span className="text-white text-[10px]">{capitalShips.player2?.currentHealth || 0}</span>
                    </div>
                  </div>
                </div>

                {/* Combat Log Modal */}
                {showCombatLog && (
                  <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
                    <div className="bg-gray-900 rounded-lg p-6 max-w-2xl w-full mx-4 border-4 border-yellow-500 max-h-[80vh] flex flex-col">
                      <h2 className="text-3xl font-bold text-yellow-400 text-center mb-4">‚öîÔ∏è COMBAT LOG ‚öîÔ∏è</h2>

                      <div className="flex-1 overflow-y-auto bg-gray-800 rounded p-4 mb-4 font-mono text-sm text-white">
                        {combatLog.map((line, i) => (
                          <div key={i} className="mb-1">{line}</div>
                        ))}
                      </div>

                      <button
                        onClick={handleCombatLogOk}
                        className="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white text-xl font-bold rounded-lg"
                      >
                        OK
                      </button>
                    </div>
                  </div>
                )}

                {/* Unit Info Modal */}
                {showUnitInfo && selectedUnit && (
                  <div
                    className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50"
                    onClick={() => setShowUnitInfo(false)}
                  >
                    <div
                      className="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 border-4"
                      style={{ borderColor: config.players[`player${selectedUnit.player}`].color }}
                      onClick={(e) => e.stopPropagation()}
                    >
                      <div className="flex items-center gap-4 mb-4">
                        <img src={config.unitTypes[selectedUnit.type].icon} alt="" className="w-16 h-16" />
                        <div>
                          <h2 className="text-2xl font-bold text-white">{config.unitTypes[selectedUnit.type].name}</h2>
                          <p className="text-gray-400 text-sm">{selectedUnit.id}</p>
                        </div>
                      </div>

                      <p className="text-gray-300 mb-4 italic">{config.unitTypes[selectedUnit.type].description}</p>

                      <div className="grid grid-cols-2 gap-3 mb-4">
                        <div className="bg-gray-700 rounded p-2">
                          <div className="text-gray-400 text-xs mb-1">Health</div>
                          <div className="flex items-center gap-2">
                            <div className="flex-1 bg-gray-600 rounded h-3">
                              <div
                                className="bg-green-500 h-full"
                                style={{ width: `${(selectedUnit.health / selectedUnit.maxHealth * 100)}%` }}
                              ></div>
                            </div>
                            <span className="text-white text-sm font-bold">{Math.round(selectedUnit.health)}/{selectedUnit.maxHealth}</span>
                          </div>
                        </div>

                        <div className="bg-gray-700 rounded p-2">
                          <div className="text-gray-400 text-xs">Damage</div>
                          <div className="text-white font-bold text-lg">{selectedUnit.damage}</div>
                        </div>

                        <div className="bg-gray-700 rounded p-2">
                          <div className="text-gray-400 text-xs">Capital Damage</div>
                          <div className="text-white font-bold text-lg">{selectedUnit.capitalDamage}</div>
                        </div>
                      </div>

                      <button
                        onClick={() => setShowUnitInfo(false)}
                        className="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg"
                      >
                        Close
                      </button>
                    </div>
                  </div>
                )}

                {winner && (
                  <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
                    <div className="bg-gray-900 border-4 border-yellow-500 rounded-xl p-8 text-center">
                      <h1 className="text-4xl font-bold text-yellow-400 mb-4">
                        üèÜ PLAYER {winner} WINS!
                      </h1>
                      <p className="text-gray-300 mb-6">
                        {winner === 1
                          ? 'The enemy fleet has been destroyed.'
                          : 'Your fleet has been annihilated.'}
                      </p>
                      <button
                        onClick={() => window.location.reload()}
                        className="px-6 py-3 bg-green-600 hover:bg-green-700 text-white text-xl rounded-lg"
                      >
                        Restart Game
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div >
          )}

          {
            config && gameState === 'custom' && (
              <div className="w-full h-full bg-gray-900 text-white flex flex-col items-center p-6">
                <h1 className="text-3xl font-bold text-purple-400 mb-6">
                  Custom Match
                </h1>

                <div className="grid grid-cols-2 gap-8 w-full max-w-5xl">

                  {/* PLAYER */}
                  <div className="bg-gray-800 rounded-lg p-4 border border-blue-500">
                    <h2 className="text-xl font-bold text-blue-400 mb-2">
                      Player Units ({customSetup.player1.length}/3)
                    </h2>

                    <div className="grid grid-cols-2 gap-2">
                      {Object.keys(config.unitTypes).map(type => {
                        const unit = config.unitTypes[type];
                        const disabled = customSetup.player1.length >= 3;

                        return (
                          <button
                            key={type}
                            disabled={disabled}
                            onClick={() =>
                              setCustomSetup(s => ({
                                ...s,
                                player1: [...s.player1, type]
                              }))
                            }
                            className={`flex items-center gap-2 p-2 rounded
                  ${disabled ? 'bg-gray-700 opacity-40' : 'bg-gray-700 hover:bg-blue-600'}
                `}
                          >
                            <img src={unit.icon} alt="" className="w-6 h-6" />
                            <span className="text-sm">{unit.name}</span>
                          </button>
                        );
                      })}
                    </div>
                  </div>

                  {/* CPU */}
                  <div className="bg-gray-800 rounded-lg p-4 border border-red-500">
                    <h2 className="text-xl font-bold text-red-400 mb-2">
                      CPU Units ({customSetup.player2.length}/3)
                    </h2>

                    <div className="grid grid-cols-2 gap-2">
                      {Object.keys(config.unitTypes).map(type => {
                        const unit = config.unitTypes[type];
                        const disabled = customSetup.player2.length >= 3;

                        return (
                          <button
                            key={type}
                            disabled={disabled}
                            onClick={() =>
                              setCustomSetup(s => ({
                                ...s,
                                player2: [...s.player2, type]
                              }))
                            }
                            className={`flex items-center gap-2 p-2 rounded
                  ${disabled ? 'bg-gray-700 opacity-40' : 'bg-gray-700 hover:bg-red-600'}
                `}
                          >
                            <img src={unit.icon} alt="" className="w-6 h-6" />
                            <span className="text-sm">{unit.name}</span>
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>

                {/* START */}
                <button
                  disabled={customSetup.player1.length !== 3 || customSetup.player2.length !== 3}
                  onClick={startCustomGame}
                  className={`mt-8 px-8 py-4 rounded-lg text-xl font-bold
        ${customSetup.player1.length === 3 && customSetup.player2.length === 3
                      ? 'bg-green-600 hover:bg-green-700'
                      : 'bg-gray-600 opacity-40 cursor-not-allowed'}
      `}
                >
                  Start Match
                </button>

                <button
                  onClick={() => setGameState('menu')}
                  className="mt-4 text-gray-400 hover:text-white underline"
                >
                  Back to Menu
                </button>
              </div>
            )
          }
        </>
      );
    };

    ReactDOM.render(<StarHexesGame />, document.getElementById('root'));
  </script>
</body>

</html>