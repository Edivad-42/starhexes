<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e293b">
    <meta name="description" content="Star Hexes - Tactical turn-based space game">
    <title>Star Hexes</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            width: 100vw;
            height: 100vh;
        }
        * {
            -webkit-tap-highlight-color: transparent;
        }
        #root {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- Load abilities system first -->
    <script src="abilities.js"></script>
    
    <!-- Menu and How To Play components (must be type="text/babel" for JSX) -->
    <script type="text/babel">
        // Main Menu Component for Star Hexes
        const MainMenu = ({ onStartGame, onShowHowToPlay }) => {
          return (
            <div className="w-full h-full bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 flex items-center justify-center">
              <div className="text-center space-y-8 px-4">
                {/* Title */}
                <div>
                  <h1 className="text-6xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-2">
                    STAR HEXES
                  </h1>
                  <p className="text-gray-400 text-lg tracking-widest">TACTICAL SPACE COMBAT</p>
                </div>
                
                {/* Main Buttons */}
                <div className="space-y-4">
                  <button
                    onClick={onStartGame}
                    className="w-64 px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold rounded-lg shadow-lg hover:shadow-blue-500/50 transition-all transform hover:scale-105 active:scale-95"
                  >
                    üéØ Quick Match
                  </button>
                  
                  <button
                    onClick={onShowHowToPlay}
                    className="w-64 px-8 py-4 bg-purple-600 hover:bg-purple-700 text-white text-xl font-bold rounded-lg shadow-lg hover:shadow-purple-500/50 transition-all transform hover:scale-105 active:scale-95"
                  >
                    üìñ How to Play
                  </button>
                  
                  {/* Coming Soon Buttons */}
                  <button
                    disabled
                    className="w-64 px-8 py-4 bg-gray-700 text-gray-500 text-xl font-bold rounded-lg cursor-not-allowed opacity-50"
                  >
                    üéÆ Campaign <span className="text-sm">(Coming Soon)</span>
                  </button>
                  
                  <button
                    disabled
                    className="w-64 px-8 py-4 bg-gray-700 text-gray-500 text-xl font-bold rounded-lg cursor-not-allowed opacity-50"
                  >
                    ‚öôÔ∏è Settings <span className="text-sm">(Coming Soon)</span>
                  </button>
                </div>
                
                {/* Version Info */}
                <div className="text-gray-500 text-sm mt-8">
                  v0.1.0 Alpha
                </div>
              </div>
            </div>
          );
        };

        // How to Play Component for Star Hexes
        const HowToPlay = ({ onBack }) => {
          return (
            <div className="w-full h-full bg-gray-900 overflow-auto">
              <div className="max-w-3xl mx-auto p-6 text-white">
                {/* Header */}
                <div className="flex items-center justify-between mb-6">
                  <h1 className="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    How to Play
                  </h1>
                  <button
                    onClick={onBack}
                    className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
                  >
                    ‚Üê Back to Menu
                  </button>
                </div>
                
                {/* Content */}
                <div className="space-y-6 text-gray-300">
                  
                  {/* Goal */}
                  <section className="bg-gray-800 rounded-lg p-4">
                    <h2 className="text-xl font-bold text-blue-400 mb-2">üéØ Goal</h2>
                    <p>
                      Win by destroying the enemy Capital Ship (reduce it to 0 HP) OR by eliminating all enemy units.
                    </p>
                  </section>
                  
                  {/* Turn Structure */}
                  <section className="bg-gray-800 rounded-lg p-4">
                    <h2 className="text-xl font-bold text-blue-400 mb-2">üîÑ Turn Structure</h2>
                    <p className="mb-2">The game alternates between <strong>Action Phase</strong> and <strong>Combat Phase</strong>:</p>
                    <ul className="list-disc list-inside space-y-1 ml-2">
                      <li><strong>Action Phase:</strong> Players take turns activating their units. Each unit can move once per round.</li>
                      <li><strong>Combat Phase:</strong> After all units are activated, simultaneous combat occurs between adjacent enemy units.</li>
                    </ul>
                  </section>
                  
                  {/* Movement & Engagement */}
                  <section className="bg-gray-800 rounded-lg p-4">
                    <h2 className="text-xl font-bold text-blue-400 mb-2">üöÄ Movement & Engagement</h2>
                    <ul className="list-disc list-inside space-y-1 ml-2">
                      <li>Units can move to any adjacent hex (1 hex per turn by default).</li>
                      <li><strong>Engaged Units:</strong> If a unit is adjacent to an enemy, it is <strong>engaged</strong> and <strong>cannot move</strong>.</li>
                      <li>You can choose to <strong>Pass</strong> without moving if needed.</li>
                    </ul>
                  </section>
                  
                  {/* Combat */}
                  <section className="bg-gray-800 rounded-lg p-4">
                    <h2 className="text-xl font-bold text-blue-400 mb-2">‚öîÔ∏è Combat</h2>
                    <ul className="list-disc list-inside space-y-1 ml-2">
                      <li>Combat happens automatically during the Combat Phase.</li>
                      <li>Units deal damage to all adjacent enemies simultaneously.</li>
                      <li>If a unit has multiple adjacent enemies, its damage is split evenly among them.</li>
                      <li>Combat events appear in the feed at the top of the screen.</li>
                    </ul>
                  </section>
                  
                  {/* Abilities */}
                  <section className="bg-gray-800 rounded-lg p-4">
                    <h2 className="text-xl font-bold text-blue-400 mb-2">‚ö° Abilities</h2>
                    <ul className="list-disc list-inside space-y-1 ml-2">
                      <li><strong>Active Abilities:</strong> Can be triggered by clicking the ability button when a unit is selected. Some abilities have limited charges or cooldowns.</li>
                      <li><strong>Movement Abilities:</strong> Replace your normal movement (e.g., Boost lets you move 2 hexes instead of 1).</li>
                      <li><strong>Attack Abilities:</strong> Allow ranged attacks or special effects. You can still move after using these.</li>
                      <li><strong>Passive Abilities:</strong> Always active and provide constant bonuses (shown as disabled buttons for reference).</li>
                      <li>Click the <strong>‚ÑπÔ∏è Info</strong> button to see details about any unit's abilities.</li>
                    </ul>
                  </section>
                  
                  {/* Capital Ships */}
                  <section className="bg-gray-800 rounded-lg p-4">
                    <h2 className="text-xl font-bold text-blue-400 mb-2">üõ°Ô∏è Capital Ships</h2>
                    <ul className="list-disc list-inside space-y-1 ml-2">
                      <li>Each player has a Capital Ship in their home zone (3 hexes highlighted in blue or red).</li>
                      <li>Capital Ships don't move but have high HP.</li>
                      <li>Units in the enemy's capital zone can damage the Capital Ship if they're not engaged with enemy units.</li>
                      <li>The amount of damage depends on the unit's <strong>Capital Damage</strong> stat.</li>
                    </ul>
                  </section>
                  
                  {/* Tips */}
                  <section className="bg-gray-800 rounded-lg p-4">
                    <h2 className="text-xl font-bold text-blue-400 mb-2">üí° Tips</h2>
                    <ul className="list-disc list-inside space-y-1 ml-2">
                      <li>Use the Info button to inspect any unit (yours or enemy) to see their stats and abilities.</li>
                      <li>Plan your moves carefully - engaged units can't retreat!</li>
                      <li>Different unit types excel at different roles: fighters for combat, bombers for capital ships.</li>
                      <li>Watch your ability cooldowns and charges to maximize their impact.</li>
                    </ul>
                  </section>
                  
                </div>
                
                {/* Bottom spacing */}
                <div className="h-8"></div>
              </div>
            </div>
          );
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const StarHexesGame = () => {
          // ==================== STATE MANAGEMENT ====================
          // Core game state
          const [gameState, setGameState] = useState('menu'); // 'menu', 'howtoplay', 'game'
          const [config, setConfig] = useState(null);
          const [units, setUnits] = useState([]);
          const [capitalShips, setCapitalShips] = useState({ player1: null, player2: null });
          const [currentPlayer, setCurrentPlayer] = useState(1);
          const [selectedUnit, setSelectedUnit] = useState(null);
          const [activatedUnits, setActivatedUnits] = useState(new Set());
          const [gamePhase, setGamePhase] = useState('action'); // 'action' or 'combat'
          const [combatEvents, setCombatEvents] = useState([]);
          const [needsAIMove, setNeedsAIMove] = useState(false);
          
          // Ability system state
          const [activeAbility, setActiveAbility] = useState(null);
          const [abilityTargets, setAbilityTargets] = useState([]);
          
          // UI state
          const [showUnitInfo, setShowUnitInfo] = useState(false);
          const [gameOver, setGameOver] = useState(null); // null, 'player1', or 'player2'
          
          // Refs for accessing state in async operations
          const unitsRef = useRef(units);
          const activatedRef = useRef(activatedUnits);
          const capitalShipsRef = useRef(capitalShips);
          
          // Keep refs in sync with state
          useEffect(() => {
            unitsRef.current = units;
            activatedRef.current = activatedUnits;
            capitalShipsRef.current = capitalShips;
          }, [units, activatedUnits, capitalShips]);

          // ==================== INITIALIZATION ====================
          // Load config and initialize game
          useEffect(() => {
            fetch('config.json')
              .then(res => res.json())
              .then(data => {
                setConfig(data);
                
                // Initialize capital ships
                setCapitalShips({
                  player1: {
                    ...data.capitalShips.player1,
                    currentHealth: data.capitalShips.player1.health
                  },
                  player2: {
                    ...data.capitalShips.player2,
                    currentHealth: data.capitalShips.player2.health
                  }
                });
                
                // Initialize units
                const initialUnits = [];
                let unitId = 1;
                
                // Player 1 units
                data.startingUnits.player1.forEach(u => {
                  const unitType = data.unitTypes[u.type];
                  const unit = {
                    id: `p1_${unitId++}`,
                    player: 1,
                    q: u.q,
                    r: u.r,
                    health: unitType.health,
                    maxHealth: unitType.health,
                    type: u.type,
                    damage: unitType.damage,
                    capitalDamage: unitType.capitalDamage
                  };
                  
                  // Initialize ability states
                  if (unitType.abilities) {
                    AbilitySystem.initAbilities(unit, unitType.abilities);
                  }
                  
                  initialUnits.push(unit);
                });
                
                // Player 2 units
                unitId = 1;
                data.startingUnits.player2.forEach(u => {
                  const unitType = data.unitTypes[u.type];
                  const unit = {
                    id: `p2_${unitId++}`,
                    player: 2,
                    q: u.q,
                    r: u.r,
                    health: unitType.health,
                    maxHealth: unitType.health,
                    type: u.type,
                    damage: unitType.damage,
                    capitalDamage: unitType.capitalDamage
                  };
                  
                  // Initialize ability states
                  if (unitType.abilities) {
                    AbilitySystem.initAbilities(unit, unitType.abilities);
                  }
                  
                  initialUnits.push(unit);
                });
                
                setUnits(initialUnits);
              })
              .catch(err => {
                console.error('Error loading config:', err);
              });
          }, []);

          // ==================== CHECK ALL UNITS ACTIVATED ====================
          // When all units are activated, trigger combat phase
          useEffect(() => {
            if (gamePhase !== 'action') return;
            
            const aliveUnits = units.filter(u => u.health > 0);
            if (aliveUnits.length === 0) return;
            
            const allActivated = aliveUnits.every(u => activatedUnits.has(u.id));
            
            if (allActivated) {
              resolveCombat();
            }
          }, [activatedUnits, gamePhase]);

          // ==================== AI MOVE TRIGGER ====================
          // Trigger AI move when it's AI's turn
          useEffect(() => {
            if (!needsAIMove || gamePhase !== 'action' || currentPlayer !== 2) return;
            
            const timer = setTimeout(() => {
              makeAIMove();
            }, config?.ui?.animationSpeed || 1000);
            
            return () => clearTimeout(timer);
          }, [needsAIMove, gamePhase, currentPlayer]);

          // ==================== VICTORY CHECK ====================
          // Check for victory conditions after combat
          useEffect(() => {
            // Don't check victory if game hasn't started or is already over
            if (gamePhase !== 'action' || gameOver || units.length === 0) return;
            if (!capitalShips.player1 || !capitalShips.player2) return;
            
            const p1Units = units.filter(u => u.player === 1 && u.health > 0);
            const p2Units = units.filter(u => u.player === 2 && u.health > 0);
            const p1Ship = capitalShips.player1;
            const p2Ship = capitalShips.player2;
            
            // Check Player 2 victory (P1 loses)
            if ((p1Units.length === 0 || p1Ship.currentHealth <= 0) && !gameOver) {
              setGameOver('player2');
              setTimeout(() => {
                if (confirm('Player 2 (Empire) wins! Play again?')) {
                  window.location.reload();
                }
              }, 500);
            }
            // Check Player 1 victory (P2 loses)
            else if ((p2Units.length === 0 || p2Ship.currentHealth <= 0) && !gameOver) {
              setGameOver('player1');
              setTimeout(() => {
                if (confirm('Player 1 (Rebels) wins! Play again?')) {
                  window.location.reload();
                }
              }, 500);
            }
          }, [units, capitalShips, gamePhase, gameOver]);

          // ==================== MENU HANDLERS ====================
          const handleStartGame = () => {
            setGameState('game');
          };
          
          const handleShowHowToPlay = () => {
            setGameState('howtoplay');
          };
          
          const handleBackToMenu = () => {
            setGameState('menu');
          };

          // ==================== LOADING STATE ====================
          if (!config) {
            return (
              <div className="w-full h-full bg-gray-800 flex items-center justify-center">
                <div className="text-white text-xl">Loading...</div>
              </div>
            );
          }

          // ==================== MENU RENDER ====================
          if (gameState === 'menu') {
            return <MainMenu onStartGame={handleStartGame} onShowHowToPlay={handleShowHowToPlay} />;
          }
          
          // ==================== HOW TO PLAY RENDER ====================
          if (gameState === 'howtoplay') {
            return <HowToPlay onBack={handleBackToMenu} />;
          }

          // ==================== HEXAGONAL GRID UTILITIES ====================
          const hexUtils = {
            getNeighbors: (q, r) => {
              const evenRow = r % 2 === 0;
              if (evenRow) {
                return [
                  [q + 1, r], [q - 1, r],
                  [q, r - 1], [q - 1, r - 1],
                  [q, r + 1], [q - 1, r + 1]
                ];
              } else {
                return [
                  [q + 1, r], [q - 1, r],
                  [q + 1, r - 1], [q, r - 1],
                  [q + 1, r + 1], [q, r + 1]
                ];
              }
            }
          };

          // ==================== UNIT ICON COMPONENT ====================
          const UnitIcon = ({ x, y, size, src }) => (
            <image
              href={src}
              x={x - size / 2}
              y={y - size / 2}
              width={size}
              height={size}
              style={{ pointerEvents: 'none' }}
            />
          );

          // ==================== UNIT QUERY FUNCTIONS ====================
          const isOccupied = (q, r, excludeId = null) => {
            return unitsRef.current.some(u => u.q === q && u.r === r && u.id !== excludeId && u.health > 0);
          };

          const getUnitAt = (q, r) => {
            return unitsRef.current.find(u => u.q === q && u.r === r && u.health > 0);
          };

          // SIMPLIFIED ENGAGEMENT: If unit is adjacent to enemy, it's engaged and can't move
          const isEngaged = (unit) => {
            const neighbors = hexUtils.getNeighbors(unit.q, unit.r);
            return neighbors.some(([q, r]) => {
              const neighbor = getUnitAt(q, r);
              return neighbor && neighbor.player !== unit.player;
            });
          };

          const canMove = (unit) => {
            return !isEngaged(unit);
          };

          const getValidMoves = (unit) => {
            if (!canMove(unit)) return [];
            
            const neighbors = hexUtils.getNeighbors(unit.q, unit.r);
            return neighbors.filter(([q, r]) => 
              q >= 0 && q < config.map.width && 
              r >= 0 && r < config.map.height && 
              !isOccupied(q, r, unit.id) &&
              !config.map.disabledHexes.some(hex => hex.q === q && hex.r === r)
            );
          };

          // ==================== ABILITY HANDLERS ====================
          const handleAbilityClick = (abilityId) => {
            if (!selectedUnit || gamePhase !== 'action' || currentPlayer !== 1) return;
            
            const ability = ABILITIES[abilityId];
            if (!ability || !ability.canUse(selectedUnit, {})) return;
            
            // Movement abilities
            if (ability.trigger === 'movement') {
              const gameStateObj = {
                config,
                isOccupied,
                getUnitAt
              };
              const result = ability.effect(selectedUnit, gameStateObj, hexUtils);
              setActiveAbility({ id: abilityId, type: 'movement', moves: result.validMoves });
              return;
            }
            
            // Attack abilities
            if (ability.trigger === 'attack') {
              const gameStateObj = {
                config,
                isOccupied,
                getUnitAt
              };
              const result = ability.effect(selectedUnit, gameStateObj, hexUtils);
              setActiveAbility({ id: abilityId, type: 'attack', targets: result.targetHexes });
              setAbilityTargets(result.targetHexes);
              return;
            }
            
            // Combat buff abilities (like preciseShot)
            if (ability.trigger === 'combat') {
              ability.onUse(selectedUnit);
              setUnits([...unitsRef.current]); // Trigger re-render
              // Don't deselect, player can still move
            }
          };

          const handleAbilityTargetClick = (q, r) => {
            if (!activeAbility || !selectedUnit) return;
            
            const ability = ABILITIES[activeAbility.id];
            
            if (activeAbility.type === 'attack') {
              // Check if target is valid
              const isValidTarget = abilityTargets.some(([tq, tr]) => tq === q && tr === r);
              if (!isValidTarget) return;
              
              // Apply attack
              const target = getUnitAt(q, r);
              if (target) {
                const attackResult = ability.onUse(selectedUnit, [q, r]);
                
                setUnits(prevUnits => prevUnits.map(u => {
                  if (u.id === target.id) {
                    const newHealth = Math.max(0, u.health - attackResult.damage);
                    return { ...u, health: newHealth };
                  }
                  return u;
                }));
                
                // Clear ability state but keep unit selected (player can still move)
                setActiveAbility(null);
                setAbilityTargets([]);
              }
            }
          };

          // ==================== UNIT CLICK HANDLER ====================
          const handleUnitClick = (unit) => {
            // During combat phase, only show info
            if (gamePhase !== 'action') {
              setSelectedUnit(unit);
              setShowUnitInfo(true);
              return;
            }
            
            // Can always select to view info
            setSelectedUnit(unit);
            
            // Clear any active ability when switching units
            setActiveAbility(null);
            setAbilityTargets([]);
            
            // Can't activate enemy units or during AI turn
            if (unit.player !== currentPlayer || currentPlayer !== 1) {
              return;
            }
            
            // Can't activate already activated units
            if (activatedUnits.has(unit.id)) {
              return;
            }
          };

          // ==================== AI MOVE LOGIC ====================
          const makeAIMove = () => {
            setNeedsAIMove(false);
            
            const aiUnits = unitsRef.current.filter(u => u.player === 2 && u.health > 0 && !activatedRef.current.has(u.id));
            
            if (aiUnits.length === 0) {
              setCurrentPlayer(1);
              return;
            }

            const aiUnit = aiUnits[0];
            const playerUnits = unitsRef.current.filter(u => u.player === 1 && u.health > 0);
            const validMoves = getValidMoves(aiUnit);

            if (!canMove(aiUnit) || validMoves.length === 0) {
              setActivatedUnits(prev => new Set([...prev, aiUnit.id]));
              setCurrentPlayer(1);
              return;
            }

            // Simple AI: move towards nearest enemy
            let bestMove = validMoves[0];
            let minDistance = Infinity;

            validMoves.forEach(([mq, mr]) => {
              playerUnits.forEach(pUnit => {
                const dist = Math.abs(mq - pUnit.q) + Math.abs(mr - pUnit.r);
                if (dist < minDistance) {
                  minDistance = dist;
                  bestMove = [mq, mr];
                }
              });
            });

            setUnits(prevUnits => prevUnits.map(u => 
              u.id === aiUnit.id ? { ...u, q: bestMove[0], r: bestMove[1] } : u
            ));
            setActivatedUnits(prev => new Set([...prev, aiUnit.id]));
            setCurrentPlayer(1);
          };

          // ==================== HEX CLICK HANDLER ====================
          const handleHexClick = (q, r) => {
            // If ability is active and it's an attack ability, handle target click
            if (activeAbility && activeAbility.type === 'attack') {
              handleAbilityTargetClick(q, r);
              return;
            }
            
            if (!selectedUnit || gamePhase !== 'action' || currentPlayer !== 1) return;
            if (selectedUnit.player !== 1) return;
            if (activatedUnits.has(selectedUnit.id)) return;
            
            // Check valid moves (either from movement ability or normal movement)
            let validMoves = [];
            if (activeAbility?.type === 'movement') {
              validMoves = activeAbility.moves;
            } else {
              validMoves = getValidMoves(selectedUnit);
            }
            
            const isValidMove = validMoves.some(([mq, mr]) => mq === q && mr === r);
            
            if (isValidMove) {
              // Apply movement ability effect if active
              if (activeAbility?.type === 'movement') {
                const ability = ABILITIES[activeAbility.id];
                ability.onUse(selectedUnit);
                setActiveAbility(null);
              }
              
              setUnits(prevUnits => prevUnits.map(u => 
                u.id === selectedUnit.id ? { ...u, q, r } : u
              ));
              setActivatedUnits(prev => new Set([...prev, selectedUnit.id]));
              setSelectedUnit(null);
              setActiveAbility(null);
              setAbilityTargets([]);
              setCurrentPlayer(2);
              setNeedsAIMove(true);
            }
          };

          // ==================== PASS HANDLER ====================
          const handlePass = () => {
            if (!selectedUnit) return;
            if (activatedUnits.has(selectedUnit.id)) return;
            if (selectedUnit.player !== 1 || currentPlayer !== 1) return;

            setActivatedUnits(prev => new Set([...prev, selectedUnit.id]));
            setSelectedUnit(null);
            setActiveAbility(null);
            setAbilityTargets([]);
            setCurrentPlayer(2);
            setNeedsAIMove(true);
          };

          const hexDistance = (a, b) => {
            const dq = a.q - b.q;
            const dr = a.r - b.r;
            return Math.max(
              Math.abs(dq),
              Math.abs(dr),
              Math.abs(dq + dr)
            );
          };

          // ==================== COMBAT RESOLUTION ====================
          const resolveCombat = () => {
            setGamePhase('combat');

            const events = [];
            const currentUnits = unitsRef.current.map(u => ({ ...u }));
            let newCapitalShips = { ...capitalShipsRef.current };

            // ==============================
            // 1Ô∏è‚É£ SNAPSHOT
            // ==============================
            const snapshot = currentUnits.map(u => ({
              id: u.id,
              q: u.q,
              r: u.r,
              player: u.player,
              damage: u.damage,
              type: u.type
            }));

            // ==============================
            // 2Ô∏è‚É£ DAMAGE ACCUMULATOR
            // ==============================
            const incomingDamage = {};
            currentUnits.forEach(u => {
              if (u.health > 0) incomingDamage[u.id] = 0;
            });

            // ==============================
            // 3Ô∏è‚É£ ATTACKS CALCULATION
            // ==============================
            snapshot.forEach(attacker => {
              const realAttacker = currentUnits.find(u => u.id === attacker.id);
              if (!realAttacker || realAttacker.health <= 0) return;

              const enemies = snapshot.filter(
                u =>
                  u.player !== attacker.player &&
                  hexDistance(attacker, u) === 1
              );

              if (enemies.length === 0) return;

              // üîπ total damage
              let totalDamage = attacker.damage;

              // üîπ bonus damage
              totalDamage = AbilitySystem.applyPassiveAttack(
                realAttacker,
                totalDamage,
                config
              );

              const damagePerEnemy = totalDamage / enemies.length;

              enemies.forEach(enemy => {
                incomingDamage[enemy.id] += damagePerEnemy;

                events.push({
                  type: 'combat',
                  text: `${attacker.id} hits ${enemy.id} (${Math.round(damagePerEnemy)} dmg)`
                });
              });
            });

            // ==============================
            // 4Ô∏è‚É£ APPLY DAMAGE
            // ==============================
            currentUnits.forEach(unit => {
              if (unit.health <= 0) return;

              let dmg = incomingDamage[unit.id] || 0;
              if (dmg > 0) {
                dmg = AbilitySystem.applyPassiveDefense(unit, dmg, config);
                unit.health = Math.max(0, unit.health - dmg);
              }
            });

            // ==============================
            // 5Ô∏è‚É£ CAPITAL SHIPS DAMAGE
            // ==============================
            currentUnits.forEach(unit => {
              if (unit.health <= 0) return;

              const isInP1Zone = config.capitalZones.player1.some(
                z => z.q === unit.q && z.r === unit.r
              );
              const isInP2Zone = config.capitalZones.player2.some(
                z => z.q === unit.q && z.r === unit.r
              );

              const isEnemyZone =
                unit.player === 1 ? isInP2Zone : isInP1Zone;

              if (!isEnemyZone) return;

              const engaged = snapshot.some(
                u =>
                  u.player !== unit.player &&
                  hexDistance(unit, u) === 1
              );

              if (!engaged) {
                const target = unit.player === 1 ? 'player2' : 'player1';
                newCapitalShips[target].currentHealth = Math.max(
                  0,
                  newCapitalShips[target].currentHealth - unit.capitalDamage
                );

                events.push({
                  type: 'capital',
                  text: `${unit.id} strikes ${newCapitalShips[target].name} (${unit.capitalDamage} dmg)`
                });
              }
            });

            // ==============================
            // 6Ô∏è‚É£ COOLDOWN (REAL UNITS)
            // ==============================
            AbilitySystem.resetCooldowns(currentUnits);

            setUnits(currentUnits);
            setCapitalShips(newCapitalShips);

            showCombatEventsSequentially(events);
          };

          // ==================== COMBAT EVENT FEED ====================
          const showCombatEventsSequentially = (events) => {
            if (events.length === 0) {
              endCombatPhase();
              return;
            }
            
            const delay = config.ui.combatEventDelay || 600;
            
            events.forEach((event, index) => {
              setTimeout(() => {
                setCombatEvents(prev => [...prev, event]);
                
                // After last event, end combat phase
                if (index === events.length - 1) {
                  setTimeout(() => {
                    endCombatPhase();
                  }, delay);
                }
              }, index * delay);
            });
          };
          
          const endCombatPhase = () => {
            setGamePhase('action');
            setActivatedUnits(new Set());
            setCombatEvents([]);
            setCurrentPlayer(1);
            setSelectedUnit(null);
          };

          // ==================== HEX GRID COMPONENT ====================
          const HexGrid = () => {
            const hexSize = config.map.hexSize;
            const hexWidth = hexSize * Math.sqrt(3);
            const hexHeight = hexSize * 2;
            const vertDist = hexHeight * 0.75;
            
            const ship1Pos = config.capitalShips.player1.position;
            const ship2Pos = config.capitalShips.player2.position;
            const disabledHexes = config.map.disabledHexes || [];
            
            const isHexDisabled = (q, r) => {
              return disabledHexes.some(hex => hex.q === q && hex.r === r);
            };
            
            const isInCapitalZone = (q, r, player) => {
              const zones = player === 1 ? config.capitalZones.player1 : config.capitalZones.player2;
              return zones.some(zone => zone.q === q && zone.r === r);
            };
            
            return (
              <svg width="100%" height="100%" className="bg-gray-900" viewBox="0 0 600 400" preserveAspectRatio="xMidYMid meet">
                
                {/* Capital ship labels */}
                <text 
                  x="10" 
                  y="100" 
                  fill="#3b82f6" 
                  fontSize="11" 
                  fontWeight="bold" 
                  letterSpacing="0.5"
                  transform="rotate(-30 10 100)"
                  style={{ transformOrigin: '10px 100px' }}
                >
                  {config.capitalShips.player1.name}
                </text>
                <text 
                  x="585" 
                  y="300" 
                  fill="#ef4444" 
                  fontSize="11" 
                  fontWeight="bold" 
                  letterSpacing="0.5"
                  textAnchor="end"
                  transform="rotate(-30 585 300)"
                  style={{ transformOrigin: '585px 300px' }}
                >
                  {config.capitalShips.player2.name}
                </text>

                {/* Hex grid */}
                {Array.from({ length: config.map.height }, (_, r) => 
                  Array.from({ length: config.map.width }, (_, q) => {
                    if (isHexDisabled(q, r)) return null;
                    
                    const x = hexWidth * q + (r % 2) * (hexWidth / 2) + 40;
                    const y = vertDist * r + 35;
                    
                    const unit = units.find(u => u.q === q && u.r === r && u.health > 0);
                    const isSelected = selectedUnit && selectedUnit.q === q && selectedUnit.r === r;
                    
                    // Get valid moves based on active ability or normal movement
                    let validMoves = [];
                    if (selectedUnit && selectedUnit.player === 1 && !activatedUnits.has(selectedUnit.id) && gamePhase === 'action') {
                      if (activeAbility?.type === 'movement') {
                        validMoves = activeAbility.moves;
                      } else {
                        validMoves = getValidMoves(selectedUnit);
                      }
                    }
                    
                    const isValidMove = validMoves.some(([mq, mr]) => mq === q && mr === r);
                    const isAbilityTarget = abilityTargets.some(([mq, mr]) => mq === q && mr === r);
                    
                    const isP1Capital = isInCapitalZone(q, r, 1);
                    const isP2Capital = isInCapitalZone(q, r, 2);
                    
                    let fillColor = '#1e293b';
                    let strokeColor = '#475569';
                    let strokeWidth = 2;
                    
                    if (isP1Capital) {
                      fillColor = '#1e3a5f';
                      strokeColor = '#3b82f6';
                      strokeWidth = 4;
                    }
                    if (isP2Capital) {
                      fillColor = '#4a1a1a'; 
                      strokeColor = '#ef4444';
                      strokeWidth = 4;
                    }
                    if (isValidMove) fillColor = '#064e3b';
                    if (isAbilityTarget) fillColor = '#7f1d1d';
                    if (isSelected) fillColor = '#fbbf24';
                    
                    return (
                      <g key={`${q}-${r}`}>
                        <polygon
                          points={`${x},${y-hexSize} ${x+hexSize*0.866},${y-hexSize/2} ${x+hexSize*0.866},${y+hexSize/2} ${x},${y+hexSize} ${x-hexSize*0.866},${y+hexSize/2} ${x-hexSize*0.866},${y-hexSize/2}`}
                          fill={fillColor}
                          stroke={strokeColor}
                          strokeWidth={strokeWidth}
                          onClick={() => {
                            // priority: active attack ability
                            if (activeAbility?.type === 'attack') {
                              handleAbilityTargetClick(q, r);
                              return;
                            }

                            // if ther's a unit, select it
                            if (unit) {
                              handleUnitClick(unit);
                              return;
                            }

                            // otherwise move
                            handleHexClick(q, r);
                          }}
                          className="cursor-pointer hover:opacity-80 transition-opacity"
                        />
                        
                        {/* Units */}
                        {unit && unit.health > 0 && (
                          <>
                            <circle
                              cx={x}
                              cy={y}
                              r={20}
                              fill={config.players[`player${unit.player}`].color}
                              stroke={activatedUnits.has(unit.id) ? '#22c55e' : '#ffffff'}
                              strokeWidth="3"
                              onClick={() => {
                                // Se un'abilit√† d'attacco √® attiva, il click √® un ATTACCO
                                if (activeAbility?.type === 'attack') {
                                  handleAbilityTargetClick(q, r);
                                  return;
                                }

                                // Altrimenti comportamento normale
                                handleUnitClick(unit);
                              }}
                              className="cursor-pointer"
                            />
                            <UnitIcon x={x} y={y} size={24} src={config.unitTypes[unit.type].icon}/>
                            {config.ui.showHealthNumbers && (
                              <text
                                x={x}
                                y={y + 12}
                                textAnchor="middle"
                                fill="white"
                                fontSize="9"
                                fontWeight="bold"
                                style={{ pointerEvents: 'none' }}
                              >
                                {Math.round(unit.health)}
                              </text>
                            )}
                          </>
                        )}
                      </g>
                    );
                  })
                )}
              </svg>
            );
          };

          // ==================== UNIT INFO MODAL ====================
          const UnitInfoModal = ({ unit, onClose }) => {
            if (!unit) return null;
            
            const unitType = config.unitTypes[unit.type];
            const playerColor = config.players[`player${unit.player}`].color;
            const abilities = AbilitySystem.getAvailableAbilities(unit, config);
            
            return (
              <div 
                className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50"
                onClick={onClose}
              >
                <div 
                  className="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 border-4"
                  style={{ borderColor: playerColor }}
                  onClick={(e) => e.stopPropagation()}
                >
                  {/* Header */}
                  <div className="flex items-center gap-4 mb-4">
                    <img src={unitType.icon} alt={unitType.name} className="w-16 h-16" />
                    <div className="flex-1">
                      <h2 className="text-2xl font-bold text-white">{unitType.name}</h2>
                      <p className="text-gray-400 text-sm">{unit.id}</p>
                    </div>
                  </div>
                  
                  {/* Description */}
                  <p className="text-gray-300 mb-4 italic">{unitType.description}</p>
                  
                  {/* Stats Grid */}
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <div className="bg-gray-700 rounded p-2">
                      <div className="text-gray-400 text-xs mb-1">Health</div>
                      <div className="flex items-center gap-2">
                        <div className="flex-1 bg-gray-600 rounded h-3 overflow-hidden">
                          <div 
                            className="bg-green-500 h-full transition-all"
                            style={{ width: `${(unit.health / unit.maxHealth * 100)}%` }}
                          ></div>
                        </div>
                        <span className="text-white text-sm font-bold">{Math.round(unit.health)}/{unit.maxHealth}</span>
                      </div>
                    </div>
                    
                    <div className="bg-gray-700 rounded p-2">
                      <div className="text-gray-400 text-xs">Damage</div>
                      <div className="text-white font-bold text-lg">{unit.damage}</div>
                    </div>
                    
                    <div className="bg-gray-700 rounded p-2">
                      <div className="text-gray-400 text-xs">Capital Damage</div>
                      <div className="text-white font-bold text-lg">{unit.capitalDamage}</div>
                    </div>
                  </div>
                  
                  {/* Abilities */}
                  {abilities.length > 0 && (
                    <div className="mb-4">
                      <h3 className="text-white font-bold mb-2">Abilities:</h3>
                      <div className="space-y-2">
                        {abilities.map(ability => (
                          <div key={ability.id} className="bg-gray-700 rounded p-2">
                            <div className="flex items-center justify-between mb-1">
                              <span className="text-white font-semibold">
                                {ability.icon} {ability.name}
                              </span>
                              {ability.type === 'active' && ability.state && (
                                <span className="text-xs text-gray-400">
                                  {ability.state.charges !== null ? `${ability.state.charges}/${ability.maxCharges}` : ''}
                                  {ability.state.cooldown > 0 ? ` (CD: ${ability.state.cooldown})` : ''}
                                </span>
                              )}
                              {ability.type === 'passive' && (
                                <span className="text-xs text-blue-400">Passive</span>
                              )}
                            </div>
                            <p className="text-gray-300 text-sm">{ability.description}</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* Close Button */}
                  <button
                    onClick={onClose}
                    className="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors"
                  >
                    Close
                  </button>
                </div>
              </div>
            );
          };

          // ==================== MAIN GAME RENDER ====================
          return (
            <div className="w-full h-full bg-gray-800 flex flex-col overflow-hidden">
              <div className="flex-1 flex flex-col overflow-hidden">
                
                {/* Top Bar */}
                <div className="flex justify-between items-center py-1 px-2 bg-gray-900 flex-shrink-0">
                  <button
                    onClick={handleBackToMenu}
                    className="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded transition-colors"
                  >
                    ‚Üê Menu
                  </button>
                  
                  <div className="text-white text-sm">
                    {gamePhase === 'action' ? (
                      <>
                        <span className={currentPlayer === 1 ? 'text-blue-400' : 'text-red-400'}>
                          P{currentPlayer}
                        </span>
                        {' '}- {currentPlayer === 1 ? 'Move unit' : 'AI thinking...'}
                      </>
                    ) : (
                      <span className="text-yellow-400">COMBAT</span>
                    )}
                  </div>
                  
                  <div className="w-16"></div>
                </div>
                
                {/* Combat Events Feed */}
                {gamePhase === 'combat' && combatEvents.length > 0 && (
                  <div className="bg-gray-800 border-b border-gray-700 px-2 py-1 flex-shrink-0">
                    <div className="space-y-1">
                      {combatEvents.slice(-4).map((event, i) => (
                        <div 
                          key={i}
                          className="text-white text-xs animate-slide-down"
                          style={{ 
                            opacity: 1 - (combatEvents.length - i - 1) * 0.2,
                            animation: 'slideDown 0.3s ease-out'
                          }}
                        >
                          {event.type === 'combat' ? '‚öîÔ∏è' : 'üéØ'} {event.text}
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                {/* Game Board */}
                <div className="flex-1 overflow-hidden relative">
                  <HexGrid />
                  
                  {/* Action Buttons */}
                  {selectedUnit && gamePhase === 'action' && selectedUnit.player === 1 && currentPlayer === 1 && !activatedUnits.has(selectedUnit.id) && (
                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 bg-gray-800 rounded-lg p-2 border border-gray-600">
                      <button
                        onClick={handlePass}
                        className="px-4 py-2 bg-gray-700 text-white rounded-lg border border-gray-500 active:bg-gray-600"
                      >
                        Pass
                      </button>
                      
                      <button
                        onClick={() => setShowUnitInfo(true)}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg border border-blue-500 active:bg-blue-700"
                      >
                        ‚ÑπÔ∏è Info
                      </button>
                      
                      {/* Ability Buttons */}
                      {config.unitTypes[selectedUnit.type].abilities && 
                       config.unitTypes[selectedUnit.type].abilities.map(abilityId => {
                        const ability = ABILITIES[abilityId];
                        if (!ability) return null;
                        
                        const canUse = ability.type === 'active' && ability.canUse ? ability.canUse(selectedUnit, {}) : false;
                        const state = selectedUnit.abilityStates?.[abilityId];
                        
                        return (
                          <button
                            key={abilityId}
                            onClick={() => handleAbilityClick(abilityId)}
                            disabled={!canUse || ability.type === 'passive'}
                            className={`px-3 py-2 rounded-lg border text-sm font-semibold transition-all ${
                              canUse && ability.type === 'active'
                                ? 'bg-blue-600 border-blue-500 text-white hover:bg-blue-700 active:bg-blue-800'
                                : 'bg-gray-700 border-gray-600 text-gray-400 cursor-not-allowed'
                            }`}
                            title={ability.description}
                          >
                            {ability.icon} {ability.name}
                            {state && state.charges !== null && (
                              <span className="ml-1 text-xs">({state.charges}/{ability.maxCharges})</span>
                            )}
                            {state && state.cooldown > 0 && (
                              <span className="ml-1 text-xs">(CD:{state.cooldown})</span>
                            )}
                            {ability.type === 'passive' && (
                              <span className="ml-1 text-xs">(Passive)</span>
                            )}
                          </button>
                        );
                      })}
                    </div>
                  )}
                  
                  {/* Info Only Button (for enemy units, activated units, or during AI turn) */}
                  {selectedUnit && (
                    (selectedUnit.player !== 1 || currentPlayer !== 1 || activatedUnits.has(selectedUnit.id)) &&
                    gamePhase === 'action' && (
                      <div className="absolute bottom-4 left-1/2 -translate-x-1/2">
                        <button
                          onClick={() => setShowUnitInfo(true)}
                          className="px-4 py-2 bg-blue-600 text-white rounded-lg border border-blue-500 active:bg-blue-700"
                        >
                          ‚ÑπÔ∏è Info
                        </button>
                      </div>
                    )
                  )}
                </div>
                
                {/* Bottom Status Bar */}
                <div className="grid grid-cols-2 gap-1 p-1 bg-gray-900 text-xs flex-shrink-0">
                  <div className="bg-blue-900 p-1 rounded">
                    <div className="flex justify-between items-center mb-1">
                      <span className="text-blue-300 font-bold">P1</span>
                      <span className="text-white">{units.filter(u => u.player === 1 && u.health > 0).length} units</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="flex-1 bg-gray-700 rounded h-2 overflow-hidden">
                        <div 
                          className="bg-blue-400 h-full transition-all"
                          style={{ width: `${(capitalShips.player1?.currentHealth / capitalShips.player1?.health * 100) || 0}%` }}
                        ></div>
                      </div>
                      <span className="text-white text-[10px]">{capitalShips.player1?.currentHealth || 0}</span>
                    </div>
                  </div>
                  <div className="bg-red-900 p-1 rounded">
                    <div className="flex justify-between items-center mb-1">
                      <span className="text-red-300 font-bold">P2</span>
                      <span className="text-white">{units.filter(u => u.player === 2 && u.health > 0).length} units</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <div className="flex-1 bg-gray-700 rounded h-2 overflow-hidden">
                        <div 
                          className="bg-red-400 h-full transition-all"
                          style={{ width: `${(capitalShips.player2?.currentHealth / capitalShips.player2?.health * 100) || 0}%` }}
                        ></div>
                      </div>
                      <span className="text-white text-[10px]">{capitalShips.player2?.currentHealth || 0}</span>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Unit Info Modal */}
              {showUnitInfo && selectedUnit && (
                <UnitInfoModal 
                  unit={selectedUnit} 
                  onClose={() => setShowUnitInfo(false)} 
                />
              )}
            </div>
          );
        };

        ReactDOM.render(<StarHexesGame />, document.getElementById('root'));
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
    
    <style>
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
</body>
</html>